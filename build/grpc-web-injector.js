/**
 * gRPC Debugger 1.0 - Frontend Injection Script
 * Redesigned for Connect-RPC and Buf ecosystem support.
 */

(function() {
  const postType = "__GRPCWEB_DEVTOOLS__";

  window.__GRPCWEB_DEVTOOLS__ = function() {
    console.log("[gRPC Debugger] API initialized.");
  };

  /**
   * New 2.0 API: Register a Connect/Buf Service definition
   * @param {Object} service - The service definition generated by @bufbuild/protobuf
   */
  window.__GRPCWEB_DEVTOOLS__.registerService = function(service) {
    if (!service || !service.typeName) {
      console.warn("[gRPC Debugger] Invalid service definition");
      return;
    }

    // Convert Connect/Buf service object to a simplified schema format for the engine
    const services = [{
      name: service.typeName.split('.').pop(),
      fullName: service.typeName,
      methods: Object.values(service.methods).map(m => ({
        name: m.name,
        requestType: m.I.typeName,
        responseType: m.O.typeName,
      }))
    }];

    // We also need the message definitions for these methods
    const messages = {};
    const collectMessages = (msg) => {
       if (!msg || !msg.typeName || messages[msg.typeName]) return;
       messages[msg.typeName] = {
         name: msg.typeName.split('.').pop(),
         fields: msg.fields.map(f => ({
           number: f.no,
           name: f.name,
           type: f.kind === 'message' ? 11 : 0, // Simplified for now
           type_name: f.T ? f.T.typeName : undefined
         }))
       };
       // Recursively collect nested messages
       msg.fields.forEach(f => f.T && collectMessages(f.T));
    };

    Object.values(service.methods).forEach(m => {
      collectMessages(m.I);
      collectMessages(m.O);
    });

    window.postMessage({
      type: postType,
      action: "registerSchema",
      schema: { services, messages }
    }, "*");
    
    console.log(`[gRPC Debugger] Registered service: ${service.typeName}`);
  };

  /**
   * New 2.0 API: Register a list of messages
   * @param {Array|Object} msgs - An array or object containing Buf message definitions
   */
  window.__GRPCWEB_DEVTOOLS__.registerMessages = function(msgs) {
    const messages = {};
    const msgList = Array.isArray(msgs) ? msgs : Object.values(msgs);
    
    const collect = (msg) => {
      if (!msg || !msg.typeName || messages[msg.typeName]) return;
      messages[msg.typeName] = {
        name: msg.typeName.split('.').pop(),
        fields: msg.fields.map(f => ({
          number: f.no,
          name: f.name,
          type: f.kind === 'message' ? 11 : (f.kind === 'scalar' ? f.scalar : 0),
          type_name: f.T ? f.T.typeName : undefined
        }))
      };
      msg.fields.forEach(f => f.T && collect(f.T));
    };

    msgList.forEach(collect);

    window.postMessage({
      type: postType,
      action: "registerSchema",
      schema: { messages }
    }, "*");
    
    console.log("[gRPC Debugger] Registered message registry.");
  };

  // --- Backward Compatibility ---
  window.__GRPCWEB_DEVTOOLS__.registerProto = function(protoDefinition) {
    window.postMessage({ type: postType, action: "registerProto", proto: protoDefinition }, "*");
  };

  window.__GRPCWEB_DEVTOOLS__.registerMethod = function(methodPath, requestType, responseType) {
    window.postMessage({ type: postType, action: "registerMethod", methodPath, requestType, responseType }, "*");
  };
  // -----------------------------

  window.dispatchEvent(new CustomEvent("grpc-web-dev-tools-ready"));
})();
